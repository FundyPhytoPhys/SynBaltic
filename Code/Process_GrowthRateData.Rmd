---
title: "Process_GrowthRateData"
author:
- Sylwia Sliwinska-Wilczewska
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
bibliography: BalticPhotoperiod.bib
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

# Set Chunk Options

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Introduction

Process_GrowthRateData.Rmd processes and combines PICO_NestedFitsData.Rds from Data/CleanData/CleanedMCData folder and Baltic_Photoperiod_Processed_OlisSpectraTidy.Rds from Data/ProcessedData/ProcessedOlisJazData. This .Rmd generates Baltic_Photoperiod_Processed_GrowthRate.Rds (stored in Data/ProcessedData/ProcessesGrowthRateData folder) and GrowthRate_Plot.png (stored in Output/Plots folder).

# Load Libraries and set Project Variables

```{r load libraries} 
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)
library(ggpubr)
library(caret)
library(reshape2)
library(gcookbook)
library(scales)
library(minpack.lm) #Standard 'nls' framework that uses 'nls.lm' for fitting
library(data.table)
library(googledrive)
library(googlesheets4)
library(tidyverse)
```

```{r set project variables}
Project <- "Baltic_Photoperiod"
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessedGrowthRateData")
DataIn <- file.path("..", "Data", "CleanData", "CleanedMCData", fsep = .Platform$file.sep)

PlotsPath <- file.path("..", "Output", "Plots")
RDSPlotPath <- file.path("..", "Output", "PlotsRDS")
RDSTablePath <- file.path("..", "Output", "TablesRDS")

FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```

# List and read files

```{r Exported Rmd only first time in session}
list.files(path = DataIn, full.names = TRUE)
```

```{r read file}
MultiCultiGrowthFile <- "../Data/CleanData/CleanedMCData/PICO_NestedFitsData.Rds"

MultiCultiGrowthFileName <- str_split(string = MultiCultiGrowthFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

MultiCultiGrowth <- readRDS(MultiCultiGrowthFile)  %>%
  ungroup()
```

# Select revelant variables and preparing for further analysis

```{r}
MultiCultiGrowth<-MultiCultiGrowth %>% 
  dplyr::select(c(Tube, ExpDate, MC, Run, SampleID, Strain, Par_ue, Photoperiod, WL, O2, LightShape, PARPhotonDose_day, OD720_Lmu_se, OD720_Lmu_corr, deltaOD_Lmu_se, deltaOD_Lmu_corr))
  
MultiCultiGrowth<-MultiCultiGrowth %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

MultiCultiGrowth1<-MultiCultiGrowth %>% 
  filter(Run==77) %>% 
  filter(Strain =="PC-rich_077")
MultiCultiGrowth2<-MultiCultiGrowth %>% 
  filter(Run==121) %>% 
  filter(Strain !="PC-rich_077")
MultiCultiGrowth3<-MultiCultiGrowth %>% 
  filter(Run!=121 & Run!= 77) 
MultiCultiGrowth<-rbind(MultiCultiGrowth1, MultiCultiGrowth2, MultiCultiGrowth3)
  rm(MultiCultiGrowth1, MultiCultiGrowth2, MultiCultiGrowth3)
```

# Load processed Olis&Jaz RDS

```{r set project variables}
Project <- "Baltic_Photoperiod"
DataIn <- file.path("..", "Data", "ProcessedData", "ProcessedOlisJazData", fsep = .Platform$file.sep)
```

# List and read processed Olis and Jaz files

```{r exported Rmd only first time in session}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

```{r read imported Olis file}
OLISSpectraFile <- "../Data/ProcessedData/ProcessedOlisJazData/Baltic_Photoperiod_Processed_OlisSpectraTidy.Rds"
OLISSpectraFileName <- str_split(string = OLISSpectraFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
OLISSpectra <- readRDS(OLISSpectraFile)  %>%
  ungroup()
```

# Combine growth rate and Tidy Olis to get PUR

```{r}
MCGrowthRate <- OLISSpectra %>% 
  left_join(., MultiCultiGrowth, by = c("Run" = "Run", "SampleID" = "SampleID","Strain" = "Strain", "Par_ue" = "Par_ue", "Photoperiod" = "Photoperiod",  "O2" = "O2", "WL" = "WL",  "MC" = "MC", "Tube" = "Tube", "ExpDate" = "ExpDate", "LightShape" = "LightShape", "PARPhotonDose_day" = "PARPhotonDose_day")) 
  rm(MultiCultiGrowth, OLISSpectra)
```

# Create preliminary plot

```{r preliminary plot, warning = FALSE}
MCGrowthRate %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = deltaOD_Lmu_corr,colour=as.factor(Strain)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = Par_ue, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Photoperiod)) +
  theme_bw()
```
# Calculated Anova and Tukey test

```{r calculated statistics}
MCGrowthRateStats<-MCGrowthRate

MCGrowthRateStats$Par_ue <- factor(MCGrowthRateStats$Par_ue)
MCGrowthRateStats$Photoperiod <- factor(MCGrowthRateStats$Photoperiod)
MCGrowthRateStats$Strain <- factor(MCGrowthRateStats$Strain)

# Two way Anova with interactions
model<-aov(deltaOD_Lmu_corr~Strain*Par_ue*Photoperiod, data=MCGrowthRateStats)
AnovaTest_GrowthRate<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
TukeyHSDTest_GrowthRate<-TukeyHSD(model, which = c("Strain", "Par_ue", "Photoperiod"))
```

# Save RDS that create stats and tables

```{r}
saveRDS(AnovaTest_GrowthRate, file.path(RDSTablePath, paste(Project, "GrowthRateAnova.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(TukeyHSDTest_GrowthRate, file.path(RDSTablePath, paste(Project, "GrowthRateTukey.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Cleaning the environment

```{r}
rm(MCGrowthRateStats, model, AnovaTest_GrowthRate, TukeyHSDTest_GrowthRate)
```

# Exstracted Exp PUR

```{r exstracted Exp PUR}

O1 <- MCGrowthRate %>%
  filter(Par_ue == 30 | Par_ue == 300 | Par_ue == 90 | Par_ue == 180) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_days < 4)

O2 <- MCGrowthRate %>%
  filter(Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 4)

O3 <- MCGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 6)

O4 <- MCGrowthRate %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 12)

O5 <- MCGrowthRate %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 4)

O6 <- MCGrowthRate %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days == 12| E_days == 13)
  
O7 <- MCGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days == 12 | E_days ==13)

O8 <- MCGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 8 | E_days ==9)

O9 <- MCGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(E_days == 11)

O10 <- MCGrowthRate %>%
  filter(Par_ue == 180) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days == 8 | E_days == 9)

O11 <- MCGrowthRate %>%
  filter(Par_ue == 180) %>% 
  filter(Photoperiod == 12) %>% 
  filter(E_days == 6 | E_days == 7)

O12 <- MCGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 8) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 6 | E_days ==7)

O13 <- MCGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 8) %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(E_days == 9)

O14 <- MCGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 4 | E_days ==5)

O15 <- MCGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PC-rich_056") %>%  
  filter(E_days == 7)

O16 <- MCGrowthRate %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12)

O17 <- MCGrowthRate %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_hours < 100 & E_hours > 48)

MCCleanGrowthAPUR <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10, O11, O12, O13, O14, O15, O16, O17)
  rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10, O11, O12, O13, O14, O15, O16, O17)
```

```{r exstracted Exp PUR, changed variable names}
MCCleanGrowthAPUR<-MCCleanGrowthAPUR %>% 
  mutate(PURExp = PUR) %>% 
  mutate(PURPhotonDoseExp = PURPhotonDose_day) %>% 
  mutate(PURPARRatioExp = PURPARRatio) %>% 
  mutate(E_hoursExp = E_hours) %>% 
  mutate(E_daysExp = E_days) %>% 
  dplyr::select(c(Strain, Par_ue, Photoperiod, PURExp, PURPhotonDoseExp, PURPARRatioExp, E_hoursExp, E_daysExp))
  
MCGrowthRateExp <- MCGrowthRate %>%
  full_join(., MCCleanGrowthAPUR, by = c("Strain"="Strain", "Par_ue"="Par_ue","Photoperiod"="Photoperiod"))

rm(MCCleanGrowthAPUR, MCGrowthRate)
```

# Load tmaxAG catalog 

```{r}
gs4_deauth()
tmaxAG<- read_sheet("https://docs.google.com/spreadsheets/d/1ksY7xlg9wOsICOBRmZkHPKdd9KOislNwPDzyuJ3UIUI/edit#gid=0")
as.data.frame(tmaxAG)
tmaxAG <- tmaxAG

tmaxAG<-tmaxAG %>% 
  mutate(Par_ue = as.numeric(Par_ue)) %>%
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(tMaxAG = as.numeric(tMaxAG)) %>%
  mutate(dayRound_tmaxAG=tMaxAG/24) %>% 
  mutate(dayRound_tmaxAG = round(dayRound_tmaxAG, digits = 0)) %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

tmaxAG$facetsPar_ue = factor(tmaxAG$O2, labels = c("PAR~(Âµmol~photons~m^{-2}~s^{-1})"))
tmaxAG$facetsPhotoperiod = factor(tmaxAG$WL, labels = c("Photoperiod~(h)"))
tmaxAG$facetsStrain = factor(tmaxAG$O2, labels = c("Strain"))
tmaxAG$facetsPARPhotonDose_day = factor(tmaxAG$WL, labels = c("PAR~photon~dose~(10^{5}~Âµmol~photons~m^{-2}~d^{-1})"))
```

```{r select revelant columns}
tMaxAGLines_056<-tmaxAG %>% 
  filter(Strain == "PC-rich_056") %>% 
  dplyr::select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_077<-tmaxAG %>% 
  filter(Strain == "PC-rich_077") %>% 
  dplyr::select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_048<-tmaxAG %>% 
  filter(Strain == "PE-rich_048") %>% 
  dplyr::select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_127<-tmaxAG %>% 
  filter(Strain == "PE-rich_127") %>% 
  dplyr::select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
```

# Create preliminary plots

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

MCGrowthRateExp %>%
  ggplot() +
  geom_point(aes(x = E_hours, y = PURPARRatio, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


MCGrowthRateExp %>%
  ggplot() +
  geom_point(aes(x = E_hoursExp, y = PURPARRatioExp, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
```

# Cleaning the environment

```{r}
rm(tMaxAGLines_056, tMaxAGLines_077, tMaxAGLines_048, tMaxAGLines_127, tmaxAG)
```

# Create preliminary plot 

```{r preliminary plot, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 ÂµE"), expression("90 ÂµE"), expression("180 ÂµE"), expression("300 ÂµE"), expression("900 ÂµE"))

O2.labs <- c("Strain")
names(O2.labs) <- c(21)
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

MCGrowthRateExp %>%
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PAR photon dose ( Âµmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw() 


MCGrowthRateExp %>%
  ggplot() +
  geom_point(aes(x = PURPhotonDoseExp, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = PURPhotonDoseExp, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PUR photon dose ( Âµmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw()
```

# Added a Starting Point (SP) at 0

```{r added starting point}
gs4_deauth()
# this is the URL or ID of a Sheet readable by anyone (with a link)
StartingPoints <- read_sheet("https://docs.google.com/spreadsheets/d/1Ns_u26HagT-kDCy5WgjGA_U8R6qv4LqRPubtlWB8Cxc/edit#gid=0") 

MCGrowthRateExpSP<-MCGrowthRateExp %>% 
  dplyr::select(c(Strain, Par_ue, Photoperiod, O2, WL, deltaOD_Lmu_se, deltaOD_Lmu_corr, PARPhotonDose_day, facetsStrain))

MCGrowthSP<-rbind(MCGrowthRateExpSP, StartingPoints)
  rm(MCGrowthRateExpSP, StartingPoints)
  
MCGrowthSP<-MCGrowthSP %>% 
  unique() %>% 
  drop_na(deltaOD_Lmu_corr) 
```

# Estimated Harrison & Platt, 1986 fit - for all uE and each uE separately

```{r platt fit}

#Harrison & Platt, 1986
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}

MCGrowthSPAllFit <- MCGrowthSP %>%   
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x,start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
GRCplatt_PredictGrowthAll <- MCGrowthSPAllFit %>% 
  unnest(GRCplatt_Predict)%>% 
  unnest(GRCplatt_Param)


MCGrowthSP30Fit <- MCGrowthSP %>%   
  filter(Par_ue ==30) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x,start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
GRCplatt_PredictGrowth30 <- MCGrowthSP30Fit %>% 
  unnest(GRCplatt_Predict)%>% 
  unnest(GRCplatt_Param)


MCGrowthSP90Fit <- MCGrowthSP %>%    
  filter(Par_ue ==90) %>%  
  nest(data = -c("Strain", "facetsStrain")) %>% 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x,start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),lower = c(0, 0, 0)))) %>%     
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
GRCplatt_PredictGrowth90 <- MCGrowthSP90Fit %>% 
  unnest(GRCplatt_Predict)%>% 
  unnest(GRCplatt_Param)


MCGrowthSP180Fit <- MCGrowthSP %>%    
  filter(Par_ue ==180) %>%  
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x,start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
GRCplatt_PredictGrowth180 <- MCGrowthSP180Fit %>% 
  unnest(GRCplatt_Predict)%>% 
  unnest(GRCplatt_Param)


MCGrowthSP300Fit <- MCGrowthSP %>%   
  filter(Par_ue ==300) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x,start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),lower = c(0, 0, 0)))) %>%     
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
GRCplatt_PredictGrowth300 <- MCGrowthSP300Fit %>% 
  unnest(GRCplatt_Predict)%>% 
  unnest(GRCplatt_Param)


MCGrowthSP900Fit <- MCGrowthSP %>%    
  filter(Par_ue ==900) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x,start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),lower = c(0, 0, 0)))) %>%     
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
        #ANOVATEST = map(GRCplatt_Model, ~ anova(deltaOD_Lmu_corr ~ Par_ue))
        #ANOVATEST2 = map2(GRCplatt_Model, fit30, fit90, anova)))
GRCplatt_PredictGrowth900 <- MCGrowthSP900Fit %>% 
  unnest(GRCplatt_Predict) %>% 
  unnest(GRCplatt_Param)

rm(MCGrowthSPAllFit, MCGrowthSP30Fit, MCGrowthSP90Fit, MCGrowthSP180Fit, MCGrowthSP300Fit, MCGrowthSP900Fit)
```

# Create preliminary plot

```{r create preliminary plot, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 ÂµE"), expression("2 ÂµE"), expression("30 ÂµE"), expression("90 ÂµE"), expression("180 ÂµE"), expression("300 ÂµE"), expression("900 ÂµE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

ggplot(MCGrowthSP, aes(PARPhotonDose_day, deltaOD_Lmu_corr)) +
  geom_point(aes(PARPhotonDose_day, deltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.8, size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=0, size=0.3, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "black", show.legend = F, GRCplatt_PredictGrowthAll) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "darkslategray", show.legend = F, GRCplatt_PredictGrowth30) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "lightblue4", show.legend = F, GRCplatt_PredictGrowth90) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "hotpink4", show.legend = F, GRCplatt_PredictGrowth180) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "indianred3", show.legend = F, GRCplatt_PredictGrowth300) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "orange1", show.legend = F, GRCplatt_PredictGrowth900) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( Âµmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() 
```

# Calculated statistics - Anova from the model

## PC-rich

```{r}
#Harrison & Platt, 1986
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}

MCGrowthSP30 <- MCGrowthSP %>%   
  filter(Par_ue ==30) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) 

MCGrowthSP3090 <- MCGrowthSP %>%   
  filter(Par_ue ==30 | Par_ue == 90) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) 

MCGrowthSP3090180 <- MCGrowthSP %>%   
  filter(Par_ue ==30 | Par_ue == 90 | Par_ue == 180) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) 

MCGrowthSP3090180300 <- MCGrowthSP %>%   
  filter(Par_ue ==30 | Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) 

MCGrowthSP3090180300900 <- MCGrowthSP %>%   
  filter(Par_ue ==30 | Par_ue == 90 | Par_ue == 180 | Par_ue == 300 | Par_ue == 900) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) 
####

MCGrowthSP30_BA56<-MCGrowthSP30 %>% 
  filter(Strain == "PC-rich_056")
MCGrowthSP3090_BA56<-MCGrowthSP3090 %>% 
  filter(Strain == "PC-rich_056")
MCGrowthSP3090180_BA56<-MCGrowthSP3090180 %>% 
  filter(Strain == "PC-rich_056")
MCGrowthSP3090180300_BA56<-MCGrowthSP3090180300 %>% 
  filter(Strain == "PC-rich_056")
MCGrowthSP3090180300900_BA56<-MCGrowthSP3090180300900 %>% 
  filter(Strain == "PC-rich_056")

MCGrowth30<-MCGrowthSP30_BA56
MCGrowth3090<-rbind(MCGrowthSP30_BA56, MCGrowthSP3090_BA56)
MCGrowth3090180<-rbind(MCGrowthSP3090_BA56, MCGrowthSP3090180_BA56)
MCGrowth3090180300<-rbind(MCGrowthSP3090180_BA56, MCGrowthSP3090180300_BA56)
MCGrowth3090180300900<-rbind(MCGrowthSP3090180300_BA56, MCGrowthSP3090180300900_BA56)
# comparing simple with more complex model
anova056_3090<-anova(MCGrowth30[[4]][[1]], MCGrowth3090[[4]][[2]]) #signifucant
anova056_3090180<-anova(MCGrowth3090[[4]][[1]], MCGrowth3090180[[4]][[2]]) #signifucant
anova056_3090180300<-anova(MCGrowth3090180[[4]][[1]], MCGrowth3090180300[[4]][[2]]) #signifucant
anova056_3090180300900<-anova(MCGrowth3090180300[[4]][[1]], MCGrowth3090180300900[[4]][[2]]) #signifucant

anova056_3090$FitComparison <- '30_3090'
anova056_3090180$FitComparison <- '180_3090'
anova056_3090180300$FitComparison <- '300_3090180'
anova056_3090180300900$FitComparison <- '900_3090180300'

ANOVAPC056<-rbind(anova056_3090, anova056_3090180, anova056_3090180300, anova056_3090180300900)
ANOVAPC056$Strain<-"PC-rich_056"
###

MCGrowthSP30_BA77<-MCGrowthSP30 %>% 
  filter(Strain == "PC-rich_077")
MCGrowthSP3090_BA77<-MCGrowthSP3090 %>% 
  filter(Strain == "PC-rich_077")
MCGrowthSP3090180_BA77<-MCGrowthSP3090180 %>% 
  filter(Strain == "PC-rich_077")
MCGrowthSP3090180300_BA77<-MCGrowthSP3090180300 %>% 
  filter(Strain == "PC-rich_077")
MCGrowthSP3090180300900_BA77<-MCGrowthSP3090180300900 %>% 
  filter(Strain == "PC-rich_077")

MCGrowth30<-MCGrowthSP30_BA77
MCGrowth3090<-rbind(MCGrowthSP30_BA77, MCGrowthSP3090_BA77)
MCGrowth3090180<-rbind(MCGrowthSP3090_BA77, MCGrowthSP3090180_BA77)
MCGrowth3090180300<-rbind(MCGrowthSP3090180_BA77, MCGrowthSP3090180300_BA77)
MCGrowth3090180300900<-rbind(MCGrowthSP3090180300_BA77, MCGrowthSP3090180300900_BA77)
# comparing simple with more complex model
anova077_3090<-anova(MCGrowth30[[4]][[1]], MCGrowth3090[[4]][[2]]) #signifucant
anova077_3090180<-anova(MCGrowth3090[[4]][[1]], MCGrowth3090180[[4]][[2]]) #signifucant
anova077_3090180300<-anova(MCGrowth3090180[[4]][[1]], MCGrowth3090180300[[4]][[2]]) #signifucant
anova077_3090180300900<-anova(MCGrowth3090180300[[4]][[1]], MCGrowth3090180300900[[4]][[2]]) #signifucant

anova077_3090$FitComparison <- '30_3090'
anova077_3090180$FitComparison <- '180_3090'
anova077_3090180300$FitComparison <- '300_3090180'
anova077_3090180300900$FitComparison <- '900_3090180300'

ANOVAPC077<-rbind(anova077_3090, anova077_3090180, anova077_3090180300, anova077_3090180300900)
ANOVAPC077$Strain<-"PC-rich_077"

rm(MCGrowth30, MCGrowth3090, MCGrowth3090180, MCGrowth3090180300, MCGrowth3090180300900, MCGrowthSP30_BA77, MCGrowthSP3090_BA77, MCGrowthSP3090180_BA77, MCGrowthSP3090180300_BA77, MCGrowthSP3090180300900_BA77, MCGrowthSP30, MCGrowthSP3090, MCGrowthSP3090180, MCGrowthSP3090180300, MCGrowthSP3090180300900, MCGrowthSP30_BA56, MCGrowthSP3090_BA56, MCGrowthSP3090180_BA56, MCGrowthSP3090180300_BA56, MCGrowthSP3090180300900_BA56, anova077_3090, anova077_3090180, anova077_3090180300, anova077_3090180300900, anova056_3090, anova056_3090180, anova056_3090180300, anova056_3090180300900)
```

## PE-rich

```{r platt fit}

#Harrison & Platt, 1986
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}

MCGrowthSP30 <- MCGrowthSP %>%   
  filter(Par_ue ==30) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) 

MCGrowthSP3090 <- MCGrowthSP %>%   
  filter(Par_ue ==30 | Par_ue == 90) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) 
###
MCGrowthSP90 <- MCGrowthSP %>%   
  filter(Par_ue == 90) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) 

MCGrowthSP90180 <- MCGrowthSP %>%   
  filter(Par_ue == 90 | Par_ue == 180) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) 

MCGrowthSP90180300 <- MCGrowthSP %>%   
  filter(Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) 

MCGrowthSP90180300900 <- MCGrowthSP %>%   
  filter(Par_ue == 90 | Par_ue == 180 | Par_ue == 300 | Par_ue == 900) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) 


MCGrowthSP30_BA048<-MCGrowthSP30 %>% 
  filter(Strain == "PE-rich_048")
MCGrowthSP3090_BA048<-MCGrowthSP3090 %>% 
  filter(Strain == "PE-rich_048")
MCGrowthSP90_BA048<-MCGrowthSP90 %>% 
  filter(Strain == "PE-rich_048")
MCGrowthSP90180_BA048<-MCGrowthSP90180 %>% 
  filter(Strain == "PE-rich_048")
MCGrowthSP90180300_BA048<-MCGrowthSP90180300 %>%
  filter(Strain == "PE-rich_048")
MCGrowthSP90180300900_BA048<-MCGrowthSP90180300900 %>%
  filter(Strain == "PE-rich_048")

MCGrowth30<-MCGrowthSP30_BA048
MCGrowth3090<-rbind(MCGrowthSP30_BA048, MCGrowthSP3090_BA048)
MCGrowth90<-MCGrowthSP90_BA048
MCGrowth90180<-rbind(MCGrowthSP90_BA048, MCGrowthSP90180_BA048)
MCGrowth90180300<-rbind(MCGrowthSP90180_BA048, MCGrowthSP90180300_BA048)
MCGrowth90180300900<-rbind(MCGrowthSP90180300_BA048, MCGrowthSP90180300900_BA048)

# comparing simple with more complex model
anova048_3090<-anova(MCGrowth30[[4]][[1]], MCGrowth3090[[4]][[2]]) #no signifucant 30
anova048_90180<-anova(MCGrowth90[[4]][[1]], MCGrowth90180[[4]][[2]]) #signifucant
anova048_90180300<-anova(MCGrowth90180[[4]][[1]], MCGrowth90180300[[4]][[2]]) #signifucant
anova048_90180300900<-anova(MCGrowth90180300[[4]][[1]], MCGrowth90180300900[[4]][[2]]) #signifucant

anova048_3090$FitComparison <- '30_3090'
anova048_90180$FitComparison <- '180_90180'
anova048_90180300$FitComparison <- '300_90180'
anova048_90180300900$FitComparison <- '900_90180300'

ANOVAPE048<-rbind(anova048_3090, anova048_90180, anova048_90180300, anova048_90180300900)
ANOVAPE048$Strain<-"PE-rich_048"


MCGrowthSP30_BA127<-MCGrowthSP30 %>% 
  filter(Strain == "PE-rich_127")
MCGrowthSP3090_BA127<-MCGrowthSP3090 %>% 
  filter(Strain == "PE-rich_127")
MCGrowthSP90_BA127<-MCGrowthSP90 %>% 
  filter(Strain == "PE-rich_127")
MCGrowthSP90180_BA127<-MCGrowthSP90180 %>% 
  filter(Strain == "PE-rich_127")
MCGrowthSP90180300_BA127<-MCGrowthSP90180300 %>%
  filter(Strain == "PE-rich_127")
MCGrowthSP90180300900_BA127<-MCGrowthSP90180300900 %>%
  filter(Strain == "PE-rich_127")

MCGrowth30<-MCGrowthSP30_BA127
MCGrowth3090<-rbind(MCGrowthSP30_BA127, MCGrowthSP3090_BA127)
MCGrowth90<-MCGrowthSP90_BA127
MCGrowth90180<-rbind(MCGrowthSP90_BA127, MCGrowthSP90180_BA127)
MCGrowth90180300<-rbind(MCGrowthSP90180_BA127, MCGrowthSP90180300_BA127)
MCGrowth90180300900<-rbind(MCGrowthSP90180300_BA127, MCGrowthSP90180300900_BA127)

# comparing simple with more complex model
anova127_3090<-anova(MCGrowth30[[4]][[1]], MCGrowth3090[[4]][[2]]) #no signifucant 30
anova127_90180<-anova(MCGrowth90[[4]][[1]], MCGrowth90180[[4]][[2]]) #signifucant
anova127_90180300<-anova(MCGrowth90180[[4]][[1]], MCGrowth90180300[[4]][[2]]) #signifucant
anova127_90180300900<-anova(MCGrowth90180300[[4]][[1]], MCGrowth90180300900[[4]][[2]]) #signifucant

anova127_3090$FitComparison <- '30_3090'
anova127_90180$FitComparison <- '180_90180'
anova127_90180300$FitComparison <- '300_90180'
anova127_90180300900$FitComparison <- '900_90180300'

ANOVAPE127<-rbind(anova127_3090, anova127_90180, anova127_90180300, anova127_90180300900)
ANOVAPE127$Strain<-"PE-rich_127"

rm(MCGrowthSP30_BA127, MCGrowthSP3090_BA127, MCGrowthSP90_BA127, MCGrowthSP90180_BA127, MCGrowthSP90180300_BA127, MCGrowthSP90180300900_BA127, MCGrowthSP30, MCGrowthSP3090, MCGrowthSP90, MCGrowthSP90180, MCGrowthSP90180300, MCGrowthSP90180300900, MCGrowth30, MCGrowth3090, MCGrowth90, MCGrowth90180, MCGrowth90180300, MCGrowth90180300900, anova127_3090, anova127_90180, anova127_90180300, anova127_90180300900, MCGrowthSP30_BA048, MCGrowthSP3090_BA048, MCGrowthSP90_BA048, MCGrowthSP90180_BA048, MCGrowthSP90180300_BA048, MCGrowthSP90180300900_BA048, anova048_3090, anova048_90180, anova048_90180300, anova048_90180300900)
```

# Combine Anova for each strains

```{r}
AnovaModel_GrowthRate<-rbind(ANOVAPC056, ANOVAPC077, ANOVAPE048, ANOVAPE127)
  rm(ANOVAPC056, ANOVAPC077, ANOVAPE048, ANOVAPE127)
```

# Save RDS that create stats and tables

```{r}
saveRDS(AnovaModel_GrowthRate, file.path(RDSTablePath, paste(Project, "GrowthRateAnovaModel.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Based on Anova, I created fits

# Estimated Harrison & Platt, 1986 fit - for all uE and each uE separately

```{r platt fit}

#Harrison & Platt, 1986
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}

MCGrowthSPFitPC <- MCGrowthSP %>%
  filter(Strain == "PC-rich_056" | Strain == "PC-rich_077") %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
GRCplatt_PredictGrowthPC <- MCGrowthSPFitPC %>% 
  unnest(GRCplatt_Predict)


MCGrowthSPFitPE30 <- MCGrowthSP %>%
  filter(Strain == "PE-rich_048" | Strain == "PE-rich_127") %>% 
  filter(Par_ue ==30) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
GRCplatt_PredictGrowthPE30 <- MCGrowthSPFitPE30 %>% 
  unnest(GRCplatt_Predict)


MCGrowthSPFitPE90900 <- MCGrowthSP %>%
  filter(Strain == "PE-rich_048" | Strain == "PE-rich_127") %>% 
  filter(Par_ue !=30) %>% 
  nest(data = -c("Strain", "facetsStrain")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PARPhotonDose_day, a, b, Pmax),
         data = .x, start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2), lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
GRCplatt_PredictGrowthPE90900 <- MCGrowthSPFitPE90900 %>% 
  unnest(GRCplatt_Predict)

rm(MCGrowthSPFitPC, MCGrowthSPFitPE30, MCGrowthSPFitPE90900)
```

# Create Growth Rate plot

```{r create growth rate plot, fig.height = 8, fig.width = 8, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 ÂµE"), expression("2 ÂµE"), expression("30 ÂµE"), expression("90 ÂµE"), expression("180 ÂµE"), expression("300 ÂµE"), expression("900 ÂµE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

ggplot(MCGrowthSP, aes(PARPhotonDose_day, deltaOD_Lmu_corr)) +
  geom_point(aes(PARPhotonDose_day, deltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.8, size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=0, size=0.3, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "gray20", size=0.7, show.legend = F, GRCplatt_PredictGrowthPC) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "gray20", size=0.7, show.legend = F, GRCplatt_PredictGrowthPE90900) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "gray20", size=0.7, show.legend = F, GRCplatt_PredictGrowthPE30) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( Âµmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.90,0.88),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=9))
```

# Save plot 

```{r save plot}
ggsave(file = file.path(PlotsPath, paste("GrowthRate_Plot",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```

# Save RDS that create plot

```{r}
saveRDS(MCGrowthSP, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_1.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowthPC, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_2.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowthPE90900, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_3.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowthPE30, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_4.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Exstracting parameters from each fit (for each light and all light together)

```{r}
GrowthRateAllParam<-GRCplatt_PredictGrowthAll %>% 
  dplyr::select(c(Strain, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRateAllParam$Fit <- 'All'

GrowthRate30Param<-GRCplatt_PredictGrowth30 %>% 
  dplyr::select(c(Strain, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRate30Param$Fit <- '30'

GrowthRate90Param<-GRCplatt_PredictGrowth90 %>% 
  dplyr::select(c(Strain, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRate90Param$Fit <- '90'
  
GrowthRate180Param<-GRCplatt_PredictGrowth180 %>% 
  dplyr::select(c(Strain, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRate180Param$Fit <- '180'
  
GrowthRate300Param<-GRCplatt_PredictGrowth300 %>% 
  dplyr::select(c(Strain, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRate300Param$Fit <- '300'
  
GrowthRate900Param<-GRCplatt_PredictGrowth900 %>% 
  dplyr::select(c(Strain, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRate900Param$Fit <- '900'
  
MCParamAll<-rbind(GrowthRateAllParam, GrowthRate30Param, GrowthRate90Param, GrowthRate180Param, GrowthRate300Param, GrowthRate900Param)

MCParamAll<-MCParamAll %>% 
  unique()

rm(GrowthRateAllParam, GrowthRate30Param, GrowthRate90Param, GrowthRate180Param, GrowthRate300Param, GrowthRate900Param)
```

# Create preliminary plot from parameters

```{r preliminary plot}
MCParamAll %>% 
  filter(term == "a") %>% 
  ggplot() +
  geom_point(aes(x = term, y = estimate, color = Strain)) +
  ggh4x::facet_nested(cols = vars(Fit), rows = vars(Strain), labeller = label_parsed, scales = "free") +
  theme_bw()

MCParamAll %>% 
  filter(term == "Pmax") %>% 
  ggplot() +
  geom_point(aes(x = term, y = estimate, color = Strain)) +
  ggh4x::facet_nested(cols = vars(Fit), rows = vars(Strain), labeller = label_parsed, scales = "free") +
  theme_bw()
```

# Calculated Anova and Tukey test from fit param

```{r calculated statistics}
# MCParamAllStats<-MCParamAll %>% 
#   filter(Fit!="All") %>% 
#   filter(term == "a")
# 
# MCParamAllStats$Fit <- factor(MCParamAllStats$Fit)
# MCParamAllStats$Strain <- factor(MCParamAllStats$Strain)
# 
# # Two way Anova with interactions
# model<-aov(estimate~Fit+Strain, data=MCParamAllStats)
# AnovaTest_GrowthRateFitParam<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
# TukeyHSDTest_GrowthRateFitParam<-TukeyHSD(model, which = c("Fit", "Strain"))
```

# Exstracting models for each fit (for each light and all light together)

```{r}

MCGrowthSPAllModel<-GRCplatt_PredictGrowthAll %>% 
  dplyr::select(c(Strain, GRCplatt_Model))
  MCGrowthSPAllModel$Fit <- 'All'

MCGrowthSP30Model<-GRCplatt_PredictGrowth30 %>% 
  dplyr::select(c(Strain, GRCplatt_Model))
  MCGrowthSP30Model$Fit <- '30'

MCGrowthSP90Model<-GRCplatt_PredictGrowth90 %>% 
  dplyr::select(c(Strain, GRCplatt_Model))
  MCGrowthSP90Model$Fit <- '90'
  
MCGrowthSP180Model<-GRCplatt_PredictGrowth180 %>% 
  dplyr::select(c(Strain, GRCplatt_Model))
  MCGrowthSP180Model$Fit <- '180'
  
MCGrowthSP300Model<-GRCplatt_PredictGrowth300 %>% 
  dplyr::select(c(Strain, GRCplatt_Model))
  MCGrowthSP300Model$Fit <- '300'
  
MCGrowthSP900Model<-GRCplatt_PredictGrowth900 %>% 
  dplyr::select(c(Strain, GRCplatt_Model))
  MCGrowthSP900Model$Fit <- '900'
  
MCModelAll<-rbind(MCGrowthSPAllModel, MCGrowthSP30Model, MCGrowthSP90Model, MCGrowthSP180Model, MCGrowthSP300Model, MCGrowthSP900Model)
MCModelAll<-MCModelAll %>% 
  unique()

rm(MCGrowthSPAllModel, MCGrowthSP30Model, MCGrowthSP90Model, MCGrowthSP180Model, MCGrowthSP300Model, MCGrowthSP900Model, GRCplatt_PredictGrowthAll, GRCplatt_PredictGrowth30, GRCplatt_PredictGrowth90, GRCplatt_PredictGrowth180, GRCplatt_PredictGrowth300, GRCplatt_PredictGrowth900)
```

# Anova from the model - compare fit from all light to selected one light

```{r}
#1->All
#2->30
#3->90
#4->180
#5->300
#6->900
MCModelAll_BA56<-MCModelAll %>% 
  filter(Strain == "PC-rich_056") 
  anova056_30<-anova(MCModelAll_BA56[[2]][[2]], MCModelAll_BA56[[2]][[1]])
  anova056_30$FitComparison <- '30_All'
  anova056_90<-anova(MCModelAll_BA56[[2]][[3]], MCModelAll_BA56[[2]][[1]])
  anova056_90$FitComparison <- '90_All'
  anova056_180<-anova(MCModelAll_BA56[[2]][[4]], MCModelAll_BA56[[2]][[1]])
  anova056_180$FitComparison <- '180_All'
  anova056_300<-anova(MCModelAll_BA56[[2]][[5]], MCModelAll_BA56[[2]][[1]])
  anova056_300$FitComparison <- '300_All'
  anova056_900<-anova(MCModelAll_BA56[[2]][[6]], MCModelAll_BA56[[2]][[1]])
  anova056_900$FitComparison <- '900_All'
  anova056<-rbind(anova056_30, anova056_90, anova056_180, anova056_300, anova056_900)
  rm(anova056_30, anova056_90, anova056_180, anova056_300, anova056_900)
  anova056$Strain <- 'PC-rich_056'
#900 no sig different 
# all significantly (except 900) -> This means that adding the 90, 180, 300 to the "simplest" model 30 did lead to a significantly improved fit over the model 30. - so 2 fits: all and 900

MCModelAll_BA77<-MCModelAll %>% 
  filter(Strain == "PC-rich_077") 
  anova077_30<-anova(MCModelAll_BA77[[2]][[2]], MCModelAll_BA77[[2]][[1]])
  anova077_30$FitComparison <- '30_All'
  anova077_90<-anova(MCModelAll_BA77[[2]][[3]], MCModelAll_BA77[[2]][[1]])
  anova077_90$FitComparison <- '90_All'
  anova077_180<-anova(MCModelAll_BA77[[2]][[4]], MCModelAll_BA77[[2]][[1]])
  anova077_180$FitComparison <- '180_All'
  anova077_300<-anova(MCModelAll_BA77[[2]][[5]], MCModelAll_BA77[[2]][[1]])
  anova077_300$FitComparison <- '300_All'
  anova077_900<-anova(MCModelAll_BA77[[2]][[6]], MCModelAll_BA77[[2]][[1]])
  anova077_900$FitComparison <- '900_All'
  anova077<-rbind(anova077_30, anova077_90, anova077_180, anova077_300, anova077_900)
  rm(anova077_30, anova077_90, anova077_180, anova077_300, anova077_900)
  anova077$Strain <- 'PC-rich_077'
#900 no sig different - so 2 fits: all and 900

MCModelAll_BA48<-MCModelAll %>% 
  filter(Strain == "PE-rich_048") 
  anova048_30<-anova(MCModelAll_BA48[[2]][[2]], MCModelAll_BA48[[2]][[1]])
  anova048_30$FitComparison <- '30_All'
  anova048_90<-anova(MCModelAll_BA48[[2]][[3]], MCModelAll_BA48[[2]][[1]])
  anova048_90$FitComparison <- '90_All'
  anova048_180<-anova(MCModelAll_BA48[[2]][[4]], MCModelAll_BA48[[2]][[1]])
  anova048_180$FitComparison <- '180_All'
  anova048_300<-anova(MCModelAll_BA48[[2]][[5]], MCModelAll_BA48[[2]][[1]])
  anova048_300$FitComparison <- '300_All'
  anova048_900<-anova(MCModelAll_BA48[[2]][[6]], MCModelAll_BA48[[2]][[1]])
  anova048_900$FitComparison <- '900_All'
  anova048<-rbind(anova048_30, anova048_90, anova048_180, anova048_300, anova048_900)
  rm(anova048_30, anova048_90, anova048_180, anova048_300, anova048_900)
  anova048$Strain <- 'PE-rich_048'
#all different - one fit

MCModelAll_BA127<-MCModelAll %>% 
  filter(Strain == "PE-rich_127") 
  anova127_30<-anova(MCModelAll_BA127[[2]][[2]], MCModelAll_BA127[[2]][[1]])
  anova127_30$FitComparison <- '30_All'
  anova127_90<-anova(MCModelAll_BA127[[2]][[3]], MCModelAll_BA127[[2]][[1]])
  anova127_90$FitComparison <- '90_All'
  anova127_180<-anova(MCModelAll_BA127[[2]][[4]], MCModelAll_BA127[[2]][[1]])
  anova127_180$FitComparison <- '180_All'
  anova127_300<-anova(MCModelAll_BA127[[2]][[5]], MCModelAll_BA127[[2]][[1]])
  anova127_300$FitComparison <- '300_All'
  anova127_900<-anova(MCModelAll_BA127[[2]][[6]], MCModelAll_BA127[[2]][[1]])
  anova127_900$FitComparison <- '900_All'
  anova127<-rbind(anova127_30, anova127_90, anova127_180, anova127_300, anova127_900)
  rm(anova127_30, anova127_90, anova127_180, anova127_300, anova127_900)
  anova127$Strain <- 'PE-rich_127'
#all different - one fit
  
AnovaModel_GrowthRate2<-rbind(anova056, anova077, anova048, anova127)
  rm(anova056, anova077, anova048, anova127, MCModelAll_BA56, MCModelAll_BA77, MCModelAll_BA48, MCModelAll_BA127)
```

# Save RDS that create stats and tables

```{r}
saveRDS(AnovaModel_GrowthRate2, file.path(RDSTablePath, paste(Project, "GrowthRateAnovaModel2.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(MCParamAll, file.path(RDSTablePath, paste(Project, "GrowthRate_FitParam.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Removed unneccessary df from the environment

```{r}
rm(GRCplatt_PredictGrowthPC, GRCplatt_PredictGrowthPE30, GRCplatt_PredictGrowthPE90900, MCGrowthSP, MCModelAll, AnovaModel_GrowthRate, AnovaModel_GrowthRate2, MCParamAll)
```

# Save rds for further analysis

```{r save rds}
saveRDS(MCGrowthRateExp, file.path(DataOut, paste(Project, "Processed_GrowthRate.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Variable names used in Data Dictionary

```{r}
colnames(MCGrowthRateExp)
```















# Other statistics

The likelihood-ratio test in statistics compares the goodness of fit of two nested regression models based on the ratio of their likelihoods, specifically one obtained by maximization over the entire parameter space and another obtained after imposing some constraint.
To see if these two models differ significantly, we can use a likelihood ratio test with the following null and alternative hypotheses.

H0: Both the full and nested models fit the data equally well. As a result, you should employ the nested model. #jezeli nie ma roznic, to nie trzeba dodawac ekstra czynnika
H1: The full model significantly outperforms the nested model in terms of data fit. As a result, you should use the entire model.

```{r}
# fullmodel <- lm(mpg ~ cyl + disp + hp + wt, data = mtcars)
# reducedmodel <- lm(mpg ~ cyl + disp, data = mtcars)
# 
# library(lmtest) #Likelihood Ratio Test
# lrtest(fullmodel, reducedmodel)
```

ANOVA testing whether the more complex model is significantly better at capturing the data than the simpler model. 

```{r}
# library(agricolae)
# data("PlantGrowth")
# plant.lm <- lm(weight ~ group, data = PlantGrowth)
# plant.av <- aov(plant.lm)
# #plant.av <- aov(weight ~ group, data = PlantGrowth) #gives the same result
# summary(plant.av)
# 
# tukey.test <- TukeyHSD(plant.av)
# tukey.test
# 
# summary(lm(weight ~ group, data = PlantGrowth))
```

# Stats with letters

```{r}
# library(agricolae)
# data(sweetpotato)
# model<-aov(yield~virus, data=sweetpotato)
# out <- HSD.test(model,"virus", group=TRUE,console=TRUE)
# plot(out)
```

# http://www.sthda.com/english/wiki/two-way-anova-test-in-r
# https://cran.r-project.org/web/packages/multcomp/vignettes/multcomp-examples.pdf
#https://r-graph-gallery.com/84-tukey-test.html
#https://pyoflife.com/anova-and-tukeys-hsd-test-with-r-how-to-compare-multiple-means-pdf/
multcomp statistic
```{r}
# library(multcomp) 
# Multiple comparisons using multcomp package
# For two-way ANOVA models, I compared the levels of the two factors simultaneously.
# I used the function glht() [in multcomp package] to perform multiple comparison procedures for an ANOVA. glht stands for general linear hypothesis tests. 
# lincft(): a specification of the linear hypotheses to be tested. Multiple comparisons in ANOVA models are specified by objects returned from the function mcp().
# Use glht() to perform multiple pairwise-comparisons.

# # Two way Anova
# model<-aov(deltaOD_Lmu_corr~Strain*Par_ue*Photoperiod, data=MCGrowthRateStats)
# Anovadf<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
# # This compare the levels of each factor:
# K1 <- glht(model, mcp(Strain = "Tukey"))$linfct
# K2 <- glht(model, mcp(Par_ue = "Tukey"))$linfc
# K3 <- glht(model, mcp(Photoperiod = "Tukey"))$linfc
# summary(glht(model, linfct = rbind(K1, K2, K3)))
# Tukey<-summary(glht(model, linfct = rbind(K1, K2, K3)))
# detach("package:multcomp", unload = TRUE)
```

Compare non-linear model parameter estimates between conditions
https://stats.stackexchange.com/questions/458195/compare-non-linear-model-parameter-estimates-between-conditions








